(this.webpackJsonpchatapp=this.webpackJsonpchatapp||[]).push([[0],{103:function(e,t,s){},112:function(e,t,s){},113:function(e,t,s){},137:function(e,t){},140:function(e,t,s){},141:function(e,t,s){},142:function(e,t,s){},143:function(e,t,s){},144:function(e,t,s){},145:function(e,t,s){"use strict";s.r(t);var a=s(0),r=s.n(a),n=s(15),i=s.n(n),o=(s(81),s(20)),c=s(6),l=s(150),h=s(148),d=s(149),g=s(151),p=s(147),m=s(32),u=s.n(m);const j=()=>{try{return localStorage.getItem("userid")}catch(e){return console.error("Error getting user ID from storage:",e),null}},v=()=>{try{return localStorage.getItem("username")}catch(e){return console.error("Error getting username from storage:",e),null}},b=e=>{try{return localStorage.getItem(e)}catch(t){return console.error("Error getting ".concat(e," from storage:"),t),null}},y=(e,t)=>{try{localStorage.setItem(e,t)}catch(s){console.error("Error setting ".concat(e," in storage:"),s)}},U=u.a.create({baseURL:"https://chatapp-api-fars.onrender.com",headers:{"Content-Type":"application/json"}});U.interceptors.request.use((e=>{const t=j(),s=v();t&&(e.headers["X-User-ID"]=t),s&&(e.headers["X-Username"]=s);const a=localStorage.getItem("token");return a&&(e.headers.Authorization="Bearer ".concat(a)),e}),(e=>(console.error("[Axios Request Error]",e),Promise.reject(e)))),U.interceptors.response.use((e=>e),(e=>(console.error("[Axios Response Error]",(null===e||void 0===e?void 0:e.response)||e),e.response&&401===e.response.status&&console.warn("\u26a0\ufe0f Unauthorized: Redirect or clear auth"),Promise.reject(e))));var S=U;var x=new class{getUserId(){return j()}getUsername(){return v()}setLS(e,t){return y(e,t)}getLS(e){return b(e)}removeLS(){return(()=>{try{localStorage.removeItem("userid"),localStorage.removeItem("username"),localStorage.removeItem("token")}catch(e){console.error("Error clearing localStorage:",e)}})()}async login(e){try{const t=await S.post("/login",e),{token:s}=t.data;return s&&y("token",s),t.data}catch(t){throw t}}async checkUsernameAvailability(e){try{const t=b("token");return(await S.post("/usernameAvailable",{username:e},{headers:{Authorization:t}})).data}catch(t){throw t}}async register(e){try{const t=b("token");return(await S.post("/register",e,{headers:{Authorization:t}})).data}catch(t){throw t}}async userSessionCheck(e){try{const t=b("token");return(await S.post("/userSessionCheck",{userId:e},{headers:{Authorization:t}})).data}catch(t){throw t}}async getMessages(e,t){try{const s=b("token");return(await S.post("/getMessages",{userId:e,toUserId:t},{headers:{Authorization:s}})).data}catch(s){throw s}}async uploadFile(e){try{return(await S.post("/upload",e,{headers:{"Content-Type":"multipart/form-data"}})).data}catch(t){throw t}}},O=(s(103),s(2));class w extends a.Component{constructor(e){super(e),this.handleLogin=async e=>{e.preventDefault(),this.props.loadingState(!0);try{const e=await x.login(this.state);this.props.loadingState(!1),e.error?this.setState({loginError:!0}):(x.setLS("userid",e.userId),this.props.history.push("/home"))}catch(t){this.props.loadingState(!1),this.setState({loginError:!0})}},this.handleInputChange=e=>{this.setState({[e.target.name]:e.target.value,loginError:!1})},this.state={username:"",password:"",loginError:!1}}render(){return Object(O.jsxs)(d.a,{className:"auth-form",children:[this.state.loginError&&Object(O.jsx)(g.a,{variant:"danger",children:"Invalid login details"}),Object(O.jsx)(d.a.Group,{controlId:"loginUsername",children:Object(O.jsx)(d.a.Control,{type:"text",name:"username",placeholder:"Enter username",onChange:this.handleInputChange})}),Object(O.jsx)(d.a.Group,{controlId:"loginPassword",children:Object(O.jsx)(d.a.Control,{type:"password",name:"password",placeholder:"Password",onChange:this.handleInputChange})}),Object(O.jsx)(p.a,{variant:"primary",type:"submit",onClick:this.handleLogin,children:"Login"})]})}}var I=Object(c.f)(w),f=s(74);s(112);class C extends a.Component{constructor(e){super(e),this.handleRegistration=async e=>{e.preventDefault(),this.props.loadingState(!0);try{const e=await x.register(this.state);this.props.loadingState(!1),e.error?this.setState({registrationError:!0}):(x.setLS("userid",e.userId),this.props.history.push("/home"))}catch(t){this.props.loadingState(!1),this.setState({registrationError:!0})}},this.checkUsernameAvailability=async e=>{if(""!==e.target.value&&void 0!==e.target.value){this.setState({username:e.target.value}),this.props.loadingState(!0);try{const e=await x.checkUsernameAvailability(this.state.username);this.props.loadingState(!1),e.error?this.setState({usernameAvailable:!1}):this.setState({usernameAvailable:!0})}catch(t){this.props.loadingState(!1),this.setState({usernameAvailable:!1})}}else""===e.target.value&&this.setState({usernameAvailable:!0})},this.handleInputChange=e=>{this.setState({[e.target.name]:e.target.value})},this.state={username:"",password:"",usernameAvailable:!0,registrationError:!1}}render(){return Object(O.jsxs)(d.a,{className:"auth-form",children:[Object(O.jsxs)(d.a.Group,{controlId:"formUsername",children:[Object(O.jsx)(f.DebounceInput,{className:"form-control",placeholder:"Enter username",minLength:2,debounceTimeout:300,onChange:this.checkUsernameAvailability}),Object(O.jsxs)(g.a,{className:"username-availability-warning ".concat(this.state.usernameAvailable?"visibility-hidden":""),variant:"danger",children:[Object(O.jsx)("strong",{children:this.state.username})," is already taken, try another username."]})]}),Object(O.jsx)(d.a.Group,{controlId:"formPassword",children:Object(O.jsx)(d.a.Control,{type:"password",name:"password",placeholder:"Password",onChange:this.handleInputChange})}),this.state.registrationError&&Object(O.jsx)(g.a,{variant:"danger",children:"Unable to register. Please try again later."}),Object(O.jsx)(p.a,{variant:"primary",type:"submit",onClick:this.handleRegistration,children:"Registration"})]})}}var k=Object(c.f)(C);s(113);class L extends a.Component{constructor(){super(...arguments),this.state={loadingState:!1},this.setRenderLoadingState=e=>{this.setState({loadingState:e})}}render(){return Object(O.jsxs)("div",{className:"container",children:[Object(O.jsx)("div",{className:"overlay auth-loading ".concat(this.state.loadingState?"":"visibility-hidden"),children:Object(O.jsx)("h1",{children:"Loading"})}),Object(O.jsx)("div",{className:"authentication-screen",children:Object(O.jsxs)(l.a,{variant:"pills",defaultActiveKey:"login",children:[Object(O.jsx)(h.a,{eventKey:"login",title:"Login",children:Object(O.jsx)(I,{loadingState:this.setRenderLoadingState})}),Object(O.jsx)(h.a,{eventKey:"registration",title:"Registration",children:Object(O.jsx)(k,{loadingState:this.setRenderLoadingState})})]})})]})}}var N=L,M=s(75),T=s(76);const E="chat-list-response",A="add-message-response",R="logout-response";var D=new class{constructor(){this.socket=null,this.eventEmitter=new T.EventEmitter}establishSocketConnection(e){try{this.socket=Object(M.io)("https://chatapp-api-fars.onrender.com",{query:"userId=".concat(e)})}catch(t){alert("Something went wrong; Can't connect to socket server")}}getChatList(e){this.socket.emit("chat-list",{userId:e}),this.socket.on(E,(e=>{this.eventEmitter.emit(E,e)}))}typing(e){this.socket.emit("typing",e)}stopTyping(e){this.socket.emit("stopTyping",e)}sendMessage(e){this.socket.emit("add-message",e)}sendMessageRead(e){this.socket.emit("message-read",e)}receiveMessage(){this.socket.on(A,(e=>{this.eventEmitter.emit(A,e)}))}logout(e){this.socket.emit("logout",e),this.socket.on(R,(e=>{this.eventEmitter.emit(R,e)}))}};s(140);class F extends a.Component{constructor(e){super(e),this.createChatListUsers=e=>{if(e.error)console.error("Unable to load Chat list, Redirecting to Login.");else{let t=this.state.chatListUsers;if(e.singleUser)t.length>0&&(t=t.filter((t=>t.id!==e.chatList[0].id))),t=[...t,...e.chatList];else if(e.userDisconnected){const s=t.findIndex((t=>t.id===e.userid));s>=0&&(t[s].online="N")}else t=e.chatList;this.setState({chatListUsers:t})}this.setState({loading:!1})},this.selectedUser=e=>{this.setState({selectedUserId:e.id}),this.props.updateSelectedUser(e)},this.state={loading:!0,selectedUserId:null,chatListUsers:[]}}componentDidMount(){const e=this.props.userId;D.getChatList(e),D.eventEmitter.on("chat-list-response",this.createChatListUsers)}componentWillUnmount(){D.eventEmitter.removeListener("chat-list-response",this.createChatListUsers)}render(){return Object(O.jsxs)(O.Fragment,{children:[Object(O.jsx)("ul",{className:"user-list ".concat(0===this.state.chatListUsers.length?"visibility-hidden":""),children:this.state.chatListUsers.map((e=>Object(O.jsxs)("li",{className:this.state.selectedUserId===e.id?"active":"",onClick:()=>this.selectedUser(e),children:[e.username,Object(O.jsx)("span",{className:"Y"===e.online?"online":"offline"})]},e.id)))}),Object(O.jsx)("div",{className:"alert \n          ".concat(this.state.loading?"alert-info":""," \n          ").concat(this.state.chatListUsers.length>0?"visibility-hidden":""),children:this.state.loading||0===this.state.chatListUsers.length?"Loading your chat list.":"No User Available to chat."})]})}}var P=F,_=s(23);s(141);class z extends a.Component{constructor(e){super(e),this.receiveSocketMessages=e=>{const{selectedUser:t}=this.state;t&&t.id===e.fromUserId&&(this.setState({conversations:[...this.state.conversations,e]}),this.scrollMessageContainer(),D.sendMessageRead({fromUserId:this.props.userId,toUserId:t.id,messageId:e._id}))},this.handleTypingIndicator=e=>{const{newSelectedUser:t}=this.props;t&&e.fromUserId===t.id&&this.setState({isTyping:!0,typingUser:e.username})},this.handleStopTypingIndicator=e=>{const{newSelectedUser:t}=this.props;t&&e.fromUserId===t.id&&this.setState({isTyping:!1,typingUser:""})},this.handleMessageRead=e=>{let{messageId:t}=e;const s=this.state.conversations.map((e=>e._id===t?Object(_.a)(Object(_.a)({},e),{},{read:!0}):e));this.setState({conversations:s})},this.getMessages=async()=>{try{const{userId:e,newSelectedUser:t}=this.props,s=await x.getMessages(e,t.id);s.error?console.error("Unable to fetch messages"):(this.setState({conversations:s.messages}),this.scrollMessageContainer()),this.setState({messageLoading:!1})}catch(e){console.error("Message fetch error:",e),this.setState({messageLoading:!1})}},this.sendMessage=e=>{if("Enter"===e.key){e.preventDefault();const t=e.target.value.trim(),{userId:s,newSelectedUser:a}=this.props;if(!t||!s||!a)return;this.sendAndUpdateMessages({fromUserId:s,message:t,toUserId:a.id,timestamp:new Date}),e.target.value="",D.stopTyping({fromUserId:s,toUserId:a.id})}},this.handleTyping=e=>{const{userId:t,newSelectedUser:s}=this.props;s&&(D.typing({fromUserId:t,toUserId:s.id,username:this.props.username||"User"}),clearTimeout(this.typingTimeout),this.typingTimeout=setTimeout((()=>{D.stopTyping({fromUserId:t,toUserId:s.id})}),1e3))},this.handleFileChange=e=>{const t=e.target.files[0];if(t){const e=URL.createObjectURL(t);this.setState({previewUrl:e,selectedFile:t})}},this.handleFileUpload=async()=>{const{userId:e,newSelectedUser:t}=this.props,{selectedFile:s}=this.state;if(s&&e&&t)try{const a=await(async e=>{const t=new FormData;t.append("image",e);try{return(await u.a.post("".concat("https://chatapp-api-fars.onrender.com","/upload"),t,{headers:{"Content-Type":"multipart/form-data"}})).data}catch(s){throw console.error("Upload failed:",s),s}})(s);if(a&&a.imageUrl){const s={fromUserId:e,toUserId:t.id,message:a.imageUrl,isFile:!0,timestamp:new Date};this.sendAndUpdateMessages(s),this.setState({previewUrl:null,selectedFile:null})}}catch(a){console.error("Upload failed:",a)}},this.state={messageLoading:!0,conversations:[],selectedUser:null,isTyping:!1,typingUser:"",previewUrl:null,selectedFile:null},this.messageContainer=r.a.createRef(),this.typingTimeout=null}componentDidMount(){D.receiveMessage(),D.socket.on("typing",this.handleTypingIndicator),D.socket.on("stopTyping",this.handleStopTypingIndicator),D.socket.on("message-read",this.handleMessageRead),D.eventEmitter.on("add-message-response",this.receiveSocketMessages)}componentWillUnmount(){D.eventEmitter.removeListener("add-message-response",this.receiveSocketMessages),D.socket.off("typing",this.handleTypingIndicator),D.socket.off("stopTyping",this.handleStopTypingIndicator),D.socket.off("message-read",this.handleMessageRead)}componentDidUpdate(e){null!==e.newSelectedUser&&this.props.newSelectedUser.id===e.newSelectedUser.id||this.getMessages()}static getDerivedStateFromProps(e,t){return null===t.selectedUser||t.selectedUser.id!==e.newSelectedUser.id?{selectedUser:e.newSelectedUser}:null}sendAndUpdateMessages(e){try{D.sendMessage(e),this.setState({conversations:[...this.state.conversations,Object(_.a)(Object(_.a)({},e),{},{read:!1})]}),this.scrollMessageContainer()}catch(t){console.error("Can't send your message",t)}}scrollMessageContainer(){if(null!==this.messageContainer.current)try{setTimeout((()=>{this.messageContainer.current.scrollTop=this.messageContainer.current.scrollHeight}),100)}catch(e){console.warn(e)}}alignMessages(e){return this.props.userId!==e}formatTimestamp(e){if(!e)return"";return new Date(e).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}getMessageUI(){return Object(O.jsx)("ul",{ref:this.messageContainer,className:"message-thread",children:this.state.conversations.map(((e,t)=>Object(O.jsxs)("li",{className:"".concat(this.alignMessages(e.toUserId)?"align-right":""),children:[Object(O.jsx)("div",{children:e.isFile?e.message.match(/\.(jpg|jpeg|png|gif)$/i)?Object(O.jsx)("img",{src:e.message,alt:"sent",className:"chat-image"}):Object(O.jsx)("a",{href:e.message,target:"_blank",rel:"noopener noreferrer",children:"Download File"}):e.message}),Object(O.jsxs)("div",{className:"message-meta",children:[Object(O.jsx)("span",{className:"timestamp",children:this.formatTimestamp(e.timestamp)}),this.alignMessages(e.toUserId)&&Object(O.jsx)("span",{className:"read-status",children:e.read?"\u2714":"\ud83d\udd53"})]})]},t)))})}getInitiateConversationUI(){if(null!==this.props.newSelectedUser)return Object(O.jsx)("div",{className:"message-thread start-chatting-banner",children:Object(O.jsxs)("p",{className:"heading",children:["You haven't chatted with ",this.props.newSelectedUser.username," in a while,",Object(O.jsx)("span",{className:"sub-heading",children:" Say Hi."})]})})}render(){const{messageLoading:e,selectedUser:t,isTyping:s,typingUser:a,previewUrl:r}=this.state;return Object(O.jsxs)(O.Fragment,{children:[Object(O.jsx)("div",{className:"message-overlay ".concat(e?"":"visibility-hidden"),children:Object(O.jsx)("h3",{children:t&&t.username?"Loading Messages":" Select a User to chat."})}),Object(O.jsxs)("div",{className:"message-wrapper ".concat(e?"visibility-hidden":""),children:[Object(O.jsxs)("div",{className:"message-container",children:[Object(O.jsxs)("div",{className:"opposite-user",children:["Chatting with"," ",this.props.newSelectedUser?this.props.newSelectedUser.username:"----"]}),this.state.conversations.length>0?this.getMessageUI():this.getInitiateConversationUI(),s&&Object(O.jsxs)("div",{className:"typing-indicator",children:[a," is typing..."]})]}),Object(O.jsx)("div",{className:"message-typer",children:Object(O.jsxs)("form",{children:[Object(O.jsx)("textarea",{className:"message form-control",placeholder:"Type and hit Enter",onKeyPress:this.sendMessage,onChange:this.handleTyping}),Object(O.jsx)("div",{className:"file-upload",children:Object(O.jsx)("input",{type:"file",onChange:this.handleFileChange,accept:"image/*,application/pdf"})}),r&&Object(O.jsxs)("div",{className:"image-preview",children:[Object(O.jsx)("img",{src:r,alt:"preview",width:"100"}),Object(O.jsx)("button",{type:"button",onClick:this.handleFileUpload,children:"Send Image"})]})]})})]})]})}}var B=z;s(142);class V extends a.Component{constructor(){super(...arguments),this.userId=null,this.state={isOverlayVisible:!0,username:"______",selectedUser:null},this.logout=async()=>{try{await x.removeLS(),D.logout({userId:this.userId}),D.eventEmitter.on("logout-response",(e=>{this.props.history.push("/")}))}catch(e){throw console.log(e),alert(" This App is Broken, we are working on it. try after some time."),e}},this.setRenderLoadingState=e=>{this.setState({isOverlayVisible:e})},this.updateSelectedUser=e=>{this.setState({selectedUser:e})},this.getChatBoxComponent=()=>this.state.isOverlayVisible?null:Object(O.jsx)(B,{userId:this.userId,newSelectedUser:this.state.selectedUser})}async componentDidMount(){try{this.setRenderLoadingState(!0),this.userId=await x.getUserId();const e=await x.userSessionCheck(this.userId);e.error?this.props.history.push("/"):(this.setState({username:e.username}),x.setLS("username",e.username),D.establishSocketConnection(this.userId)),this.setRenderLoadingState(!1)}catch(e){this.setRenderLoadingState(!1),this.props.history.push("/")}}getChatListComponent(){return this.state.isOverlayVisible?null:Object(O.jsx)(P,{userId:this.userId,updateSelectedUser:this.updateSelectedUser})}render(){return Object(O.jsxs)("div",{className:"App",children:[Object(O.jsx)("div",{className:"".concat(this.state.isOverlayVisible?"overlay":"visibility-hidden"," "),children:Object(O.jsx)("h1",{children:"Loading"})}),Object(O.jsxs)("header",{className:"app-header",children:[Object(O.jsx)("nav",{className:"navbar navbar-expand-md",children:Object(O.jsxs)("h4",{children:["Hello ",this.state.username," "]})}),Object(O.jsx)("ul",{className:"nav justify-content-end",children:Object(O.jsx)("li",{className:"nav-item",children:Object(O.jsx)("a",{className:"nav-link",href:"#",onClick:this.logout,children:"Logout"})})})]}),Object(O.jsx)("main",{role:"main",className:"container content",children:Object(O.jsxs)("div",{className:"row chat-content",children:[Object(O.jsx)("div",{className:"col-3 chat-list-container",children:this.getChatListComponent()}),Object(O.jsx)("div",{className:"col-8 message-container",children:this.getChatBoxComponent()})]})})]})}}var G=Object(c.f)(V);s(143);class K extends a.Component{render(){return Object(O.jsx)("div",{className:"App",children:"NotFound Component"})}}var W=K;s(144);class q extends a.Component{render(){return Object(O.jsx)(o.a,{children:Object(O.jsxs)(c.c,{children:[Object(O.jsx)(c.a,{path:"/",exact:!0,component:N}),Object(O.jsx)(c.a,{path:"/home/",component:G}),Object(O.jsx)(c.a,{component:W})]})})}}var H=q;Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));i.a.render(Object(O.jsx)(H,{}),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then((e=>{e.unregister()}))},81:function(e,t,s){}},[[145,1,2]]]);
//# sourceMappingURL=main.3fa4914c.chunk.js.map